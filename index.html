<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angeleads GeoMap Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <style>
        body { background-color: #111827; color: white; -webkit-tap-highlight-color: transparent; }
        .input-focus:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        #map { height: 55vh; width: 100%; z-index: 1; } /* Mapa ocupa 55% da tela */
        .leaflet-routing-container { display: none !important; }
        
        /* Animação do Modal */
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body x-data="geoApp()">

    <div x-show="view === 'home'" class="h-screen flex flex-col justify-center items-center bg-gray-900">
        <div class="text-center mb-8">
            <i class="fa-solid fa-map-location-dot text-5xl text-blue-500 mb-4"></i>
            <h1 class="text-2xl font-bold tracking-tight">Angeleads<br><span class="text-gray-500 text-sm font-normal">Sniper Logistics</span></h1>
        </div>
        <button @click="view = 'input'" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-full shadow-lg shadow-blue-900/40 text-lg">
            INICIAR OPERAÇÃO
        </button>
    </div>

    <div x-show="view === 'input'" class="min-h-screen flex flex-col bg-gray-900 p-6 pb-32">
        <h2 class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-6 text-center">Montar Rota de Recuperação</h2>
        
        <div class="bg-gray-800 rounded-2xl p-5 border border-gray-700 shadow-xl relative">
            <div x-show="loading" class="absolute inset-0 bg-gray-800/95 z-10 flex flex-col items-center justify-center rounded-2xl">
                <i class="fa-solid fa-satellite-dish fa-spin text-blue-500 text-3xl"></i>
                <p class="text-xs text-gray-400 mt-3 font-bold uppercase">Triangulando GPS...</p>
            </div>

            <label class="text-xs text-gray-400 font-bold uppercase ml-1">Nome do Cliente</label>
            <input type="text" x-model="tempNome" placeholder="Ex: Dona Maria" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 mt-1 mb-4 input-focus font-bold">
            
            <label class="text-xs text-gray-400 font-bold uppercase ml-1">Endereço ou Ponto de Ref.</label>
            <div class="flex gap-2 mt-1">
                <input type="text" x-model="tempEndereco" placeholder="Rua, Número - Bairro" class="w-full bg-gray-900 text-white p-3 rounded-lg border border-gray-700 input-focus">
                <button @click="startVoice()" class="w-14 bg-gray-700 rounded-lg flex items-center justify-center border border-gray-600 hover:bg-red-500 transition-colors">
                    <i class="fa-solid fa-microphone text-white"></i>
                </button>
            </div>
            
            <button @click="addPoint()" class="w-full mt-5 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg flex justify-center items-center gap-2 border border-slate-600">
                <i class="fa-solid fa-crosshairs text-blue-400"></i> Localizar Alvo
            </button>
        </div>

        <div class="mt-6 space-y-2">
            <template x-for="(ponto, index) in pontos" :key="index">
                <div class="flex justify-between items-center bg-gray-800/50 p-3 rounded-lg border border-gray-700/50">
                    <div>
                        <p class="font-bold text-sm text-white" x-text="ponto.nome"></p>
                        <p class="text-[10px] text-gray-500 uppercase" x-text="ponto.lat.toFixed(4) + ', ' + ponto.lon.toFixed(4)"></p>
                    </div>
                    <button @click="removePoint(index)" class="text-red-500 px-3 py-1"><i class="fa-solid fa-trash"></i></button>
                </div>
            </template>
        </div>

        <div class="fixed bottom-0 left-0 w-full p-4 bg-gradient-to-t from-gray-900 via-gray-900 to-transparent">
            <button @click="renderMap()" x-show="pontos.length > 0" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-xl flex justify-center items-center gap-2 text-lg">
                <i class="fa-solid fa-route"></i> TRAÇAR ROTA
            </button>
        </div>
    </div>

    <div x-show="view === 'map'" class="h-screen bg-gray-900 flex flex-col relative">
        <div class="p-3 flex justify-between items-center bg-gray-800 border-b border-gray-700 z-20 shadow-md">
            <div>
                <h2 class="text-white font-bold text-sm">Rota em Execução</h2>
                <p class="text-xs text-gray-400" x-text="pontos.length + ' Paradas'"></p>
            </div>
            <button @click="view = 'input'" class="bg-gray-700 text-xs text-white px-3 py-1.5 rounded font-bold">EDITAR</button>
        </div>

        <div id="map"></div>

        <div class="flex-1 bg-gray-900 p-2 overflow-y-auto pb-6">
            <h3 class="text-[10px] text-gray-500 font-bold uppercase mb-2 pl-2 mt-2">Checklist de Visitas</h3>
            <div class="space-y-2">
                <template x-for="(ponto, index) in pontos" :key="index">
                    <div @click="openActionModal(index)" 
                         class="flex items-center justify-between bg-gray-800 p-3 rounded-xl border border-gray-700 active:bg-gray-700 transition-colors cursor-pointer relative overflow-hidden">
                        
                        <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="getStatusColor(ponto.status)"></div>

                        <div class="flex items-center gap-3 pl-2">
                            <span class="bg-gray-700 text-gray-300 w-7 h-7 rounded-full flex items-center justify-center text-xs font-bold shadow-inner" x-text="index + 1"></span>
                            <div>
                                <p class="text-sm font-bold text-white leading-tight" x-text="ponto.nome"></p>
                                <p class="text-[10px] text-gray-400 mt-0.5 truncate max-w-[150px]" x-text="ponto.enderecoOriginal"></p>
                            </div>
                        </div>

                        <div class="flex flex-col items-end">
                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wide"
                                  :class="getStatusBadgeClass(ponto.status)"
                                  x-text="ponto.statusLabel">
                            </span>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div x-show="modalOpen" class="absolute inset-0 z-[1000] bg-black/80 backdrop-blur-sm flex items-end justify-center" @click.self="modalOpen = false">
            <div class="bg-gray-800 w-full rounded-t-3xl p-6 border-t border-gray-600 slide-up shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-bold text-lg">Feedback da Visita</h3>
                    <button @click="modalOpen = false" class="text-gray-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <p class="text-gray-400 text-sm mb-6">Qual foi o resultado com <span class="text-white font-bold" x-text="activePonto?.nome"></span>?</p>

                <div class="grid grid-cols-2 gap-3">
                    <button @click="setStatus('reativado', 'Reativado')" class="bg-green-600 hover:bg-green-500 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2 border border-green-500/50">
                        <i class="fa-solid fa-handshake text-2xl"></i> REATIVADO
                    </button>
                    
                    <button @click="setStatus('agendado', 'Agendado')" class="bg-yellow-600 hover:bg-yellow-500 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2 border border-yellow-500/50">
                        <i class="fa-solid fa-calendar-check text-2xl"></i> AGENDADO
                    </button>

                    <button @click="setStatus('mudou', 'Se Mudou')" class="bg-orange-600 hover:bg-orange-500 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2 border border-orange-500/50">
                        <i class="fa-solid fa-truck-moving text-2xl"></i> SE MUDOU
                    </button>

                    <button @click="setStatus('recusou', 'Não Quer')" class="bg-red-600 hover:bg-red-500 text-white p-4 rounded-xl font-bold flex flex-col items-center gap-2 border border-red-500/50">
                        <i class="fa-solid fa-user-slash text-2xl"></i> RECUSOU
                    </button>
                </div>
                
                <a :href="getWazeLink()" target="_blank" class="block w-full text-center mt-4 text-blue-400 font-bold text-sm py-3 border border-blue-900 rounded-lg bg-blue-900/20">
                    <i class="fa-brands fa-waze"></i> Abrir no Waze
                </a>
            </div>
        </div>
    </div>

    <script>
        function geoApp() {
            return {
                view: 'home',
                tempNome: '',
                tempEndereco: '',
                pontos: [],
                loading: false,
                mapInstance: null,
                modalOpen: false,
                activeIndex: null,

                get activePonto() {
                    return this.activeIndex !== null ? this.pontos[this.activeIndex] : null;
                },

                async addPoint() {
                    if (!this.tempEndereco) return;
                    this.loading = true;
                    let busca = this.tempEndereco;
                    if (!busca.toLowerCase().includes("porto velho")) busca += ", Porto Velho, Brazil";

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(busca)}`);
                        const data = await response.json();

                        if (data && data.length > 0) {
                            this.pontos.push({
                                nome: this.tempNome || `Cliente ${this.pontos.length + 1}`,
                                lat: parseFloat(data[0].lat),
                                lon: parseFloat(data[0].lon),
                                enderecoOriginal: this.tempEndereco,
                                status: 'pendente', // pendente, reativado, agendado, mudou, recusou
                                statusLabel: 'A Caminho'
                            });
                            this.tempNome = '';
                            this.tempEndereco = '';
                        } else {
                            alert("GPS não localizou. Tente nome da rua e bairro.");
                        }
                    } catch (e) {
                        alert("Erro de GPS.");
                    } finally {
                        this.loading = false;
                    }
                },

                removePoint(index) { this.pontos.splice(index, 1); },

                startVoice() {
                    const recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
                    recognition.lang = 'pt-BR';
                    recognition.onresult = (e) => { this.tempEndereco = e.results[0][0].transcript; };
                    recognition.start();
                },

                // LÓGICA DE STATUS
                openActionModal(index) {
                    this.activeIndex = index;
                    this.modalOpen = true;
                },

                setStatus(code, label) {
                    this.pontos[this.activeIndex].status = code;
                    this.pontos[this.activeIndex].statusLabel = label;
                    this.modalOpen = false;
                },

                getWazeLink() {
                    if(!this.activePonto) return '#';
                    return `https://waze.com/ul?ll=${this.activePonto.lat},${this.activePonto.lon}&navigate=yes`;
                },

                getStatusColor(status) {
                    const map = {
                        'pendente': 'bg-blue-500',
                        'reativado': 'bg-green-500',
                        'agendado': 'bg-yellow-500',
                        'mudou': 'bg-orange-500',
                        'recusou': 'bg-red-500'
                    };
                    return map[status] || 'bg-gray-500';
                },

                getStatusBadgeClass(status) {
                    const map = {
                        'pendente': 'text-blue-300 border-blue-900 bg-blue-900/30',
                        'reativado': 'text-green-300 border-green-900 bg-green-900/30',
                        'agendado': 'text-yellow-300 border-yellow-900 bg-yellow-900/30',
                        'mudou': 'text-orange-300 border-orange-900 bg-orange-900/30',
                        'recusou': 'text-red-300 border-red-900 bg-red-900/30'
                    };
                    return map[status];
                },

                renderMap() {
                    this.view = 'map';
                    setTimeout(() => {
                        if (this.mapInstance) this.mapInstance.remove();
                        
                        const centro = this.pontos.length > 0 ? [this.pontos[0].lat, this.pontos[0].lon] : [-8.761, -63.903];
                        this.mapInstance = L.map('map').setView(centro, 13);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(this.mapInstance);

                        const waypoints = this.pontos.map(p => L.latLng(p.lat, p.lon));

                        L.Routing.control({
                            waypoints: waypoints,
                            routeWhileDragging: false,
                            addWaypoints: false,
                            draggableWaypoints: false,
                            show: false,
                            lineOptions: { styles: [{color: '#3b82f6', opacity: 0.8, weight: 6}] },
                            createMarker: function(i, wp, nWps) {
                                return L.marker(wp.latLng).bindPopup(`<b>Parada ${i + 1}</b>`);
                            }
                        }).addTo(this.mapInstance);
                    }, 100);
                }
            }
        }
    </script>
</body>
</html>
